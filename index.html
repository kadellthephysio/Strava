<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KadellThePhysio Data</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c10;
    --surface: #111318;
    --surface2: #1a1d25;
    --border: #252830;
    --accent: #fc4c02;
    --accent2: #ff8c42;
    --green: #22c55e;
    --yellow: #f59e0b;
    --blue: #3b82f6;
    --purple: #a855f7;
    --text: #e8eaf0;
    --muted: #6b7280;
    --mono: 'DM Mono', monospace;
    --sans: 'Syne', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(252,76,2,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(252,76,2,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 860px;
    margin: 0 auto;
    padding: 40px 24px 80px;
    position: relative;
    z-index: 1;
  }

  /* Header */
  .header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 48px;
    animation: fadeDown 0.6s ease both;
  }

  .logo-area h1 {
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: -0.03em;
    line-height: 1;
  }

  .logo-area h1 span {
    color: var(--accent);
  }

  .logo-area p {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-top: 6px;
  }

  .strava-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--muted);
  }

  .strava-badge .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--muted);
  }
  .strava-badge.connected .dot { background: var(--green); box-shadow: 0 0 8px var(--green); }
  .strava-badge.connected { color: var(--text); }

  /* Setup panel */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    margin-bottom: 20px;
    animation: fadeUp 0.5s ease both;
  }

  .panel-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }

  .panel-num {
    width: 28px; height: 28px;
    border-radius: 6px;
    background: var(--accent);
    color: white;
    font-family: var(--mono);
    font-size: 0.75rem;
    font-weight: 500;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  .panel-num.done { background: var(--green); }
  .panel-num.locked { background: var(--surface2); color: var(--muted); }

  .panel-title {
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: -0.01em;
  }

  .panel-sub {
    font-family: var(--mono);
    font-size: 0.68rem;
    color: var(--muted);
    margin-top: 2px;
  }

  /* Form elements */
  .field-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .field label {
    font-family: var(--mono);
    font-size: 0.68rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .field input {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.8rem;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  .field input:focus { border-color: var(--accent); }
  .field input::placeholder { color: var(--muted); }

  .hint {
    background: rgba(252,76,2,0.06);
    border: 1px solid rgba(252,76,2,0.2);
    border-radius: 8px;
    padding: 12px 16px;
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--accent2);
    line-height: 1.7;
    margin-bottom: 16px;
  }

  .hint a { color: var(--accent); }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 8px;
    font-family: var(--sans);
    font-size: 0.85rem;
    font-weight: 700;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    text-decoration: none;
    letter-spacing: 0.01em;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
  }
  .btn-primary:hover { background: #e04400; transform: translateY(-1px); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { background: var(--muted); cursor: not-allowed; transform: none; }

  .btn-outline {
    background: transparent;
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }

  .btn-ghost {
    background: var(--surface2);
    color: var(--muted);
    font-size: 0.75rem;
    padding: 8px 14px;
  }
  .btn-ghost:hover { color: var(--text); background: var(--border); }

  /* Activity card */
  .activity-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 20px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .activity-card:hover { border-color: var(--accent); }
  .activity-card.selected { border-color: var(--accent); background: rgba(252,76,2,0.05); }

  .activity-card .act-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .act-name {
    font-weight: 700;
    font-size: 0.9rem;
  }

  .act-date {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--muted);
  }

  .act-stats {
    display: flex;
    gap: 20px;
  }

  .act-stat {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .act-stat .val {
    font-family: var(--mono);
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text);
  }

  .act-stat .lbl {
    font-family: var(--mono);
    font-size: 0.6rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  /* Metrics dashboard */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .metric-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    position: relative;
    overflow: hidden;
  }

  .metric-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--accent);
  }

  .metric-card.green::before { background: var(--green); }
  .metric-card.yellow::before { background: var(--yellow); }
  .metric-card.blue::before { background: var(--blue); }
  .metric-card.purple::before { background: var(--purple); }

  .metric-label {
    font-family: var(--mono);
    font-size: 0.62rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 8px;
  }

  .metric-value {
    font-family: var(--mono);
    font-size: 1.6rem;
    font-weight: 500;
    line-height: 1;
    margin-bottom: 4px;
  }

  .metric-sub {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--muted);
  }

  /* HR Zone bar */
  .zone-bar {
    display: flex;
    height: 20px;
    border-radius: 6px;
    overflow: hidden;
    margin: 12px 0 8px;
    gap: 2px;
  }

  .zone-seg {
    height: 100%;
    transition: width 0.8s ease;
    border-radius: 2px;
  }

  .zone-legend {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .zone-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-family: var(--mono);
    font-size: 0.62rem;
    color: var(--muted);
  }

  .zone-dot {
    width: 8px; height: 8px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  /* ACWR gauge */
  .acwr-display {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .acwr-gauge {
    position: relative;
    width: 80px; height: 80px;
    flex-shrink: 0;
  }

  .acwr-gauge svg { transform: rotate(-90deg); }

  .acwr-text {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--mono);
    font-size: 0.9rem;
    font-weight: 500;
    transform: none;
  }

  .acwr-info { flex: 1; }
  .acwr-info .status {
    font-weight: 700;
    font-size: 0.85rem;
    margin-bottom: 4px;
  }
  .acwr-info .desc {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--muted);
    line-height: 1.5;
  }

  /* Caption preview */
  .caption-box {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    font-family: var(--mono);
    font-size: 0.78rem;
    line-height: 1.8;
    white-space: pre-wrap;
    color: var(--text);
    margin-bottom: 16px;
    min-height: 80px;
  }

  .caption-box .new-content {
    color: var(--accent2);
    border-left: 2px solid var(--accent);
    padding-left: 10px;
    margin-left: -10px;
  }

  /* Status messages */
  .status-bar {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
  }

  .status-bar.error { border-color: #ef4444; color: #ef4444; background: rgba(239,68,68,0.05); }
  .status-bar.success { border-color: var(--green); color: var(--green); background: rgba(34,197,94,0.05); }
  .status-bar.loading { border-color: var(--accent); color: var(--accent2); background: rgba(252,76,2,0.05); }

  .spinner {
    width: 12px; height: 12px;
    border: 2px solid rgba(252,76,2,0.3);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
  }

  /* KM chart */
  .km-chart {
    display: flex;
    align-items: flex-end;
    gap: 3px;
    height: 60px;
    margin: 12px 0 6px;
  }

  .km-bar-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    height: 100%;
    justify-content: flex-end;
  }

  .km-bar {
    width: 100%;
    border-radius: 3px 3px 0 0;
    transition: height 0.6s ease;
    min-height: 2px;
  }

  .km-bar-label {
    font-family: var(--mono);
    font-size: 0.5rem;
    color: var(--muted);
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
  }

  .km-avg-line {
    position: relative;
    margin-top: -2px;
  }

  /* Sections */
  .section-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 8px 0 16px;
    font-family: var(--mono);
    font-size: 0.62rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .section-divider::before, .section-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .hidden { display: none !important; }

  /* Animations */
  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .panel:nth-child(2) { animation-delay: 0.1s; }
  .panel:nth-child(3) { animation-delay: 0.2s; }
  .panel:nth-child(4) { animation-delay: 0.3s; }

  .tag {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 4px;
    font-family: var(--mono);
    font-size: 0.62rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .tag-optimal { background: rgba(34,197,94,0.15); color: var(--green); }
  .tag-caution { background: rgba(245,158,11,0.15); color: var(--yellow); }
  .tag-high { background: rgba(239,68,68,0.15); color: #ef4444; }
  .tag-low { background: rgba(59,130,246,0.15); color: var(--blue); }

  @media (max-width: 640px) {
    .field-row { grid-template-columns: 1fr; }
    .metrics-grid { grid-template-columns: 1fr 1fr; }
    .logo-area h1 { font-size: 1.5rem; }
  }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="logo-area">
      <h1>KADELL<span>DATA</span></h1>
        <p>KadellThePhysio Â· Training Load Analysis</p>
    </div>
    <div class="strava-badge" id="connectionBadge">
      <div class="dot"></div>
      <span id="connectionLabel">Not connected</span>
    </div>
  </div>

  <!-- Step 1: API Setup -->
  <div class="panel" id="setupPanel">
    <div class="panel-header">
      <div class="panel-num" id="step1Num">1</div>
      <div>
        <div class="panel-title">Connect Strava API</div>
        <div class="panel-sub">One-time setup â€” your credentials stay in your browser only</div>
      </div>
    </div>

    <div class="hint">
      â‘  Go to <a href="https://www.strava.com/settings/api" target="_blank">strava.com/settings/api</a> â†’ Create App<br>
      â‘¡ Set <strong>Authorization Callback Domain</strong> to your domain (or <code>localhost</code> for local use)<br>
      â‘¢ Copy your <strong>Client ID</strong> and <strong>Client Secret</strong> below<br>
      â‘£ Set <strong>Athlete Heart Rate</strong> scope on authorization â€” app requests this automatically
    </div>

    <div class="field-row">
      <div class="field">
        <label>Client ID</label>
        <input type="text" id="clientId" placeholder="e.g. 12345" />
      </div>
      <div class="field">
        <label>Client Secret</label>
        <input type="password" id="clientSecret" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:center;">
      <button class="btn btn-primary" onclick="initiateAuth()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
        Authorise with Strava
      </button>
      <button class="btn btn-ghost" onclick="loadSavedCredentials()">Load Saved</button>
    </div>
  </div>

  <!-- Step 2: Pick Activity -->
  <div class="panel" id="activityPanel">
    <div class="panel-header">
      <div class="panel-num locked" id="step2Num">2</div>
      <div>
        <div class="panel-title">Select Run to Analyse</div>
        <div class="panel-sub">Fetches your last 10 runs â€” pick the one just uploaded from Garmin</div>
      </div>
    </div>

    <div id="activityStatus" class="hidden"></div>
    <div id="activityList"></div>

    <div style="display:flex; gap:10px; margin-top:4px;">
      <button class="btn btn-primary" id="fetchBtn" onclick="fetchActivities()" disabled>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        Fetch Recent Runs
      </button>
      <button class="btn btn-outline" id="analyseBtn" onclick="analyseSelected()" disabled>Analyse Selected â†’</button>
    </div>
  </div>

  <!-- Step 3: Analysis Results -->
  <div class="panel hidden" id="resultsPanel">
    <div class="panel-header">
      <div class="panel-num" id="step3Num">3</div>
      <div>
        <div class="panel-title">KadellThePhysio Data</div>
        <div class="panel-sub">28-day rolling metrics Â· Weather-adjusted Â· Ready to append to Strava</div>
      </div>
    </div>

    <div class="section-divider">Weekly Distance</div>
    <div class="metrics-grid" id="kmMetrics"></div>
    <div id="kmChart" style="padding: 0 4px;"></div>

    <div class="section-divider">Training Stress Score</div>
    <div class="metrics-grid" id="tssMetrics"></div>

    <div class="section-divider">Heart Rate Zones</div>
    <div id="hrZones"></div>

    <div class="section-divider">Weather & Pace Analysis</div>
    <div id="weatherPace"></div>

    <div class="section-divider">Caption Preview</div>
    <div class="caption-box" id="captionPreview"></div>

    <div id="updateStatus" class="hidden"></div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn btn-primary" id="updateBtn" onclick="updateStrava()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        Update Strava Caption
      </button>
      <button class="btn btn-outline" onclick="copyCaption()">Copy Caption Text</button>
      <button class="btn btn-ghost" onclick="resetAnalysis()">â† New Run</button>
    </div>
  </div>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
  clientId: '',
  clientSecret: '',
  accessToken: '',
  athleteId: '',
  activities: [],
  selectedActivity: null,
  analysisData: null
};

const ZONES = [
  { label: 'Z1 Recovery', color: '#3b82f6', max_pct: 0.6 },
  { label: 'Z2 Aerobic',  color: '#22c55e', max_pct: 0.7 },
  { label: 'Z3 Tempo',    color: '#f59e0b', max_pct: 0.8 },
  { label: 'Z4 Threshold',color: '#f97316', max_pct: 0.9 },
  { label: 'Z5 VO2max',   color: '#ef4444', max_pct: 1.0 }
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// OAuth flow
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initiateAuth() {
  const clientId = document.getElementById('clientId').value.trim();
  const clientSecret = document.getElementById('clientSecret').value.trim();

  if (!clientId || !clientSecret) {
    showStatus('activityStatus', 'error', 'Please enter both Client ID and Client Secret');
    return;
  }

  // Save credentials
  localStorage.setItem('strava_client_id', clientId);
  localStorage.setItem('strava_client_secret', clientSecret);
  state.clientId = clientId;
  state.clientSecret = clientSecret;

  const redirectUri = window.location.href.split('?')[0].split('#')[0];
  const scope = 'read,activity:read_all,activity:write';
  const authUrl = `https://www.strava.com/oauth/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&approval_prompt=force&scope=${scope}`;

  window.location.href = authUrl;
}

async function handleCallback() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  if (!code) return false;

  // Clean URL
  window.history.replaceState({}, '', window.location.pathname);

  const clientId = localStorage.getItem('strava_client_id');
  const clientSecret = localStorage.getItem('strava_client_secret');

  if (!clientId || !clientSecret) {
    showStatus('activityStatus', 'error', 'Credentials missing â€” please re-enter and authorise again');
    return false;
  }

  state.clientId = clientId;
  state.clientSecret = clientSecret;
  document.getElementById('clientId').value = clientId;

  showStatus('activityStatus', 'loading', 'Exchanging auth code for access tokenâ€¦');

  try {
    const res = await fetch('https://www.strava.com/oauth/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        client_id: clientId,
        client_secret: clientSecret,
        code,
        grant_type: 'authorization_code'
      })
    });

    const data = await res.json();
    if (data.errors) throw new Error(data.message || 'Auth failed');

    state.accessToken = data.access_token;
    state.athleteId = data.athlete?.id;

    // Cache token (in real prod you'd handle refresh_token too)
    localStorage.setItem('strava_access_token', data.access_token);
    localStorage.setItem('strava_token_expiry', data.expires_at);
    localStorage.setItem('strava_refresh_token', data.refresh_token);

    setConnected(data.athlete?.firstname || 'Athlete');
    hideStatus('activityStatus');
    return true;
  } catch (e) {
    showStatus('activityStatus', 'error', `Auth error: ${e.message}`);
    return false;
  }
}

async function refreshTokenIfNeeded() {
  const expiry = parseInt(localStorage.getItem('strava_token_expiry') || '0');
  const now = Math.floor(Date.now() / 1000);

  if (now < expiry - 300) {
    // Token still valid
    state.accessToken = localStorage.getItem('strava_access_token');
    return true;
  }

  const refreshToken = localStorage.getItem('strava_refresh_token');
  const clientId = localStorage.getItem('strava_client_id');
  const clientSecret = localStorage.getItem('strava_client_secret');

  if (!refreshToken || !clientId || !clientSecret) return false;

  try {
    const res = await fetch('https://www.strava.com/oauth/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        client_id: clientId,
        client_secret: clientSecret,
        refresh_token: refreshToken,
        grant_type: 'refresh_token'
      })
    });
    const data = await res.json();
    if (data.errors) return false;

    state.accessToken = data.access_token;
    localStorage.setItem('strava_access_token', data.access_token);
    localStorage.setItem('strava_token_expiry', data.expires_at);
    localStorage.setItem('strava_refresh_token', data.refresh_token);
    return true;
  } catch { return false; }
}

function loadSavedCredentials() {
  const clientId = localStorage.getItem('strava_client_id');
  const clientSecret = localStorage.getItem('strava_client_secret');
  if (clientId) document.getElementById('clientId').value = clientId;
  if (clientSecret) document.getElementById('clientSecret').value = '(saved)';
}

function setConnected(name) {
  const badge = document.getElementById('connectionBadge');
  badge.classList.add('connected');
  document.getElementById('connectionLabel').textContent = `${name} connected`;
  document.getElementById('step2Num').classList.remove('locked');
  document.getElementById('fetchBtn').disabled = false;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Fetch activities
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchActivities() {
  const valid = await refreshTokenIfNeeded();
  if (!valid || !state.accessToken) {
    showStatus('activityStatus', 'error', 'Not authenticated. Please authorise with Strava first.');
    return;
  }

  showStatus('activityStatus', 'loading', 'Fetching your recent runsâ€¦');

  try {
    // Fetch last 30 activities, filter runs
    const res = await fetch('https://www.strava.com/api/v3/athlete/activities?per_page=30', {
      headers: { Authorization: `Bearer ${state.accessToken}` }
    });

    if (!res.ok) throw new Error(`Strava API error: ${res.status}`);
    const all = await res.json();
    state.activities = all.filter(a => a.type === 'Run' || a.sport_type === 'Run').slice(0, 10);

    if (!state.activities.length) {
      showStatus('activityStatus', 'error', 'No runs found in recent activities.');
      return;
    }

    hideStatus('activityStatus');
    renderActivityList();
    setConnected(state.activities[0]?.athlete?.firstname || 'Athlete');

  } catch (e) {
    showStatus('activityStatus', 'error', `Error: ${e.message}`);
  }
}

function renderActivityList() {
  const list = document.getElementById('activityList');

  // Also fetch history for last 28 days for load calc
  fetchHistoryInBackground();

  list.innerHTML = state.activities.map((a, i) => {
    const km = (a.distance / 1000).toFixed(1);
    const pace = a.moving_time && a.distance ? fmtPace(a.moving_time / (a.distance / 1000)) : '--';
    const duration = fmtDuration(a.moving_time);
    const date = new Date(a.start_date_local).toLocaleDateString('en-AU', { weekday:'short', day:'numeric', month:'short' });
    const hr = a.average_heartrate ? Math.round(a.average_heartrate) + ' bpm' : '--';

    return `
      <div class="activity-card" id="act-${i}" onclick="selectActivity(${i})">
        <div class="act-top">
          <div class="act-name">${a.name}</div>
          <div class="act-date">${date}</div>
        </div>
        <div class="act-stats">
          <div class="act-stat"><div class="val">${km} km</div><div class="lbl">Distance</div></div>
          <div class="act-stat"><div class="val">${duration}</div><div class="lbl">Duration</div></div>
          <div class="act-stat"><div class="val">${pace}/km</div><div class="lbl">Avg Pace</div></div>
          <div class="act-stat"><div class="val">${hr}</div><div class="lbl">Avg HR</div></div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('analyseBtn').disabled = true;
}

let historyActivities = [];

async function fetchHistoryInBackground() {
  // Fetch last 28 days for load calcs
  const after = Math.floor((Date.now() - 28 * 86400000) / 1000);
  try {
    const res = await fetch(`https://www.strava.com/api/v3/athlete/activities?per_page=100&after=${after}`, {
      headers: { Authorization: `Bearer ${state.accessToken}` }
    });
    if (!res.ok) return;
    const all = await res.json();
    historyActivities = all.filter(a => a.type === 'Run' || a.sport_type === 'Run');
  } catch {}
}

function selectActivity(index) {
  document.querySelectorAll('.activity-card').forEach(el => el.classList.remove('selected'));
  document.getElementById(`act-${index}`).classList.add('selected');
  state.selectedActivity = state.activities[index];
  document.getElementById('analyseBtn').disabled = false;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Analysis
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function analyseSelected() {
  if (!state.selectedActivity) return;

  const act = state.selectedActivity;

  showStatus('activityStatus', 'loading', 'Loading detailed stats for this runâ€¦');

  let detail = act;
  let rawZones = null;
  let hadRealZones = false;

  try {
    const [detRes, zoneRes] = await Promise.all([
      fetch(`https://www.strava.com/api/v3/activities/${act.id}`, {
        headers: { Authorization: `Bearer ${state.accessToken}` }
      }),
      fetch(`https://www.strava.com/api/v3/activities/${act.id}/zones`, {
        headers: { Authorization: `Bearer ${state.accessToken}` }
      })
    ]);

    if (detRes.ok) detail = await detRes.json();
    if (zoneRes.ok) {
      const zData = await zoneRes.json();
      rawZones = zData.find(z => z.type === 'heartrate');
      if (rawZones && rawZones.distribution_buckets && rawZones.distribution_buckets.some(b => b.time > 0)) {
        hadRealZones = true;
      }
    }
  } catch(e) { console.warn('Fetch error:', e); }

  hideStatus('activityStatus');

  // â”€â”€ Compute metrics â”€â”€
  const kmThis = detail.distance / 1000;

  // Weekly km (this week Monâ€“Sun)
  const nowD = new Date();
  const weekStart = new Date(nowD);
  weekStart.setDate(nowD.getDate() - nowD.getDay() + (nowD.getDay() === 0 ? -6 : 1));
  weekStart.setHours(0,0,0,0);

  const thisWeekKm = historyActivities
    .filter(a => new Date(a.start_date_local) >= weekStart)
    .reduce((s, a) => s + a.distance / 1000, 0);

  const weeklyKms = [0,1,2,3].map(w => {
    const wEnd = new Date(weekStart.getTime() - w * 7 * 86400000);
    const wStart2 = new Date(wEnd.getTime() - 7 * 86400000);
    return historyActivities
      .filter(a => { const d = new Date(a.start_date_local); return d >= wStart2 && d < wEnd; })
      .reduce((s, a) => s + a.distance / 1000, 0);
  });

  const rollingAvg28 = historyActivities.reduce((s, a) => s + a.distance / 1000, 0) / 4;

  // Use actual max HR from activity if available, otherwise 185 as sensible default
  const hrMax = detail.max_heartrate || 185;
  const avgHR = detail.average_heartrate || 150;
  const movingSec = detail.moving_time || 0;
  const intensityFactor = Math.min(avgHR / hrMax, 1);
  const tss = Math.round((movingSec / 3600) * intensityFactor * intensityFactor * 100);

  const allTSS = historyActivities.map(a => {
    const hr = a.average_heartrate || 150;
    const maxHr = a.max_heartrate || hrMax;
    const sec = a.moving_time || 0;
    const IF2 = Math.min(hr / maxHr, 1);
    return (sec / 3600) * IF2 * IF2 * 100;
  });

  const ctl28 = allTSS.length ? allTSS.reduce((s,v) => s+v, 0) / 28 : 0;
  const atl7 = allTSS.slice(0,7).reduce((s,v) => s+v, 0) / Math.min(7, allTSS.length || 1);
  const acwr = ctl28 > 0 ? (atl7 / ctl28) : null;

  // HR zones
  let zoneSeconds = [0, 0, 0, 0, 0];
  if (hadRealZones && rawZones.distribution_buckets) {
    zoneSeconds = rawZones.distribution_buckets.map(b => b.time || 0);
    while (zoneSeconds.length < 5) zoneSeconds.push(0);
    zoneSeconds = zoneSeconds.slice(0, 5);
  } else if (movingSec > 0) {
    const pct = intensityFactor;
    if (pct < 0.6)      zoneSeconds = [movingSec*0.80, movingSec*0.15, movingSec*0.04, movingSec*0.01, 0];
    else if (pct < 0.7) zoneSeconds = [movingSec*0.10, movingSec*0.65, movingSec*0.20, movingSec*0.04, movingSec*0.01];
    else if (pct < 0.8) zoneSeconds = [movingSec*0.05, movingSec*0.30, movingSec*0.50, movingSec*0.12, movingSec*0.03];
    else if (pct < 0.9) zoneSeconds = [movingSec*0.02, movingSec*0.10, movingSec*0.30, movingSec*0.50, movingSec*0.08];
    else                zoneSeconds = [movingSec*0.01, movingSec*0.05, movingSec*0.10, movingSec*0.20, movingSec*0.64];
  }

  const totalZoneSec = zoneSeconds.reduce((s,v) => s+v, 0) || 1;
  const zonePcts = zoneSeconds.map(s => s / totalZoneSec);
  const dominantZone = zonePcts.indexOf(Math.max(...zonePcts));

  state.analysisData = {
    act: detail,
    kmThis,
    thisWeekKm,
    weeklyKms,
    rollingAvg28,
    tss,
    ctl28,
    atl7,
    acwr,
    zoneSeconds,
    zonePcts,
    dominantZone,
    intensityFactor,
    hadRealZones,
    weather: null,
    weeklyPaces: null
  };

  // â”€â”€ Pace trend: this week vs last week avg pace â”€â”€
  const thisWeekRuns = historyActivities.filter(a => new Date(a.start_date_local) >= weekStart && a.average_speed > 0);
  const lastWeekStart = new Date(weekStart.getTime() - 7 * 86400000);
  const lastWeekRuns = historyActivities.filter(a => {
    const d = new Date(a.start_date_local);
    return d >= lastWeekStart && d < weekStart && a.average_speed > 0;
  });

  const avgPaceThisWeek = thisWeekRuns.length
    ? thisWeekRuns.reduce((s, a) => s + (1000 / a.average_speed), 0) / thisWeekRuns.length
    : null;
  const avgPaceLastWeek = lastWeekRuns.length
    ? lastWeekRuns.reduce((s, a) => s + (1000 / a.average_speed), 0) / lastWeekRuns.length
    : null;

  state.analysisData.avgPaceThisWeek = avgPaceThisWeek;
  state.analysisData.avgPaceLastWeek = avgPaceLastWeek;

  renderResults();

  // â”€â”€ Fetch weather in background using activity GPS coords â”€â”€
  const lat = detail.start_latlng?.[0];
  const lng = detail.start_latlng?.[1];
  const activityTime = Math.floor(new Date(detail.start_date).getTime() / 1000);

  if (lat && lng) {
    fetchWeather(lat, lng, activityTime).then(w => {
      state.analysisData.weather = w;
      renderWeatherPace();
      renderCaption();
    });
  } else {
    renderWeatherPace();
  }
}

function renderResults() {
  const d = state.analysisData;
  const act = d.act;

  document.getElementById('resultsPanel').classList.remove('hidden');
  document.getElementById('step3Num').classList.add('done');
  document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });

  // â”€â”€ KM Metrics â”€â”€
  const weekDiff = d.rollingAvg28 > 0 ? ((d.thisWeekKm - d.rollingAvg28) / d.rollingAvg28 * 100) : 0;
  const weekColor = weekDiff > 10 ? 'yellow' : weekDiff < -20 ? 'blue' : 'green';
  const weekTag = weekDiff > 10 ? 'tag-caution' : weekDiff < -20 ? 'tag-low' : 'tag-optimal';

  document.getElementById('kmMetrics').innerHTML = `
    <div class="metric-card ${weekColor}">
      <div class="metric-label">This Week</div>
      <div class="metric-value">${d.thisWeekKm.toFixed(1)}<span style="font-size:0.8rem;color:var(--muted)"> km</span></div>
      <div class="metric-sub">vs ${d.rollingAvg28.toFixed(1)} km avg <span class="tag ${weekTag}">${weekDiff>0?'+':''}${weekDiff.toFixed(0)}%</span></div>
    </div>
    <div class="metric-card">
      <div class="metric-label">28-Day Avg/Week</div>
      <div class="metric-value">${d.rollingAvg28.toFixed(1)}<span style="font-size:0.8rem;color:var(--muted)"> km</span></div>
      <div class="metric-sub">Chronic load baseline</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">This Run</div>
      <div class="metric-value">${d.kmThis.toFixed(1)}<span style="font-size:0.8rem;color:var(--muted)"> km</span></div>
      <div class="metric-sub">${fmtDuration(act.moving_time)} Â· ${fmtPace(act.moving_time/(act.distance/1000))}/km</div>
    </div>
  `;

  // Mini bar chart
  const allWeeks = [d.thisWeekKm, ...d.weeklyKms];
  const maxKm = Math.max(...allWeeks, d.rollingAvg28, 1);
  const labels = ['This wk', '-1 wk', '-2 wk', '-3 wk', '-4 wk'];
  document.getElementById('kmChart').innerHTML = `
    <div style="font-family:var(--mono);font-size:0.62rem;color:var(--muted);margin-bottom:4px;">Weekly km â€” last 4 weeks</div>
    <div class="km-chart">
      ${allWeeks.map((km, i) => `
        <div class="km-bar-wrap">
          <div class="km-bar" style="height:${(km/maxKm)*100}%;background:${i===0?'var(--accent)':'var(--surface2)'};border:1px solid ${i===0?'var(--accent)':'var(--border)'};"></div>
          <div class="km-bar-label">${labels[i]}</div>
        </div>
      `).join('')}
      <div class="km-bar-wrap" style="opacity:0.5;">
        <div class="km-bar" style="height:${(d.rollingAvg28/maxKm)*100}%;background:var(--green);border:1px solid var(--green);"></div>
        <div class="km-bar-label">Avg</div>
      </div>
    </div>
  `;

  // â”€â”€ TSS Metrics â”€â”€
  let acwrColor = 'green', acwrTag = 'tag-optimal', acwrLabel = 'Optimal', acwrDesc = 'Load progression is well-managed. Good adaptation stimulus.';
  if (d.acwr !== null) {
    if (d.acwr < 0.8) { acwrColor = 'blue'; acwrTag = 'tag-low'; acwrLabel = 'Low Load'; acwrDesc = 'Acute load is below chronic. Safe to increase this week.'; }
    else if (d.acwr > 1.3) { acwrColor = 'yellow'; acwrTag = 'tag-caution'; acwrLabel = 'High Load'; acwrDesc = 'Spike detected. High injury risk â€” consider an easy day.'; }
    else if (d.acwr > 1.5) { acwrColor = 'high'; acwrTag = 'tag-high'; acwrLabel = 'Danger Zone'; acwrDesc = 'Acute:Chronic > 1.5. Rest or reduce significantly.'; }
  }

  const acwrVal = d.acwr !== null ? d.acwr.toFixed(2) : 'N/A';
  const gaugeColor = acwrColor === 'green' ? '#22c55e' : acwrColor === 'blue' ? '#3b82f6' : acwrColor === 'yellow' ? '#f59e0b' : '#ef4444';
  const gaugePct = d.acwr !== null ? Math.min(d.acwr / 2, 1) : 0.5;
  const circumference = 2 * Math.PI * 30;
  const dash = gaugePct * circumference;

  document.getElementById('tssMetrics').innerHTML = `
    <div class="metric-card">
      <div class="metric-label">Run TSS</div>
      <div class="metric-value">${d.tss}<span style="font-size:0.8rem;color:var(--muted)"> pts</span></div>
      <div class="metric-sub">Intensity factor: ${(d.intensityFactor*100).toFixed(0)}%</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">CTL (Fitness)</div>
      <div class="metric-value">${d.ctl28.toFixed(1)}<span style="font-size:0.8rem;color:var(--muted)"> TSS/d</span></div>
      <div class="metric-sub">28-day chronic load</div>
    </div>
    <div class="metric-card ${acwrColor}">
      <div class="metric-label">ACWR</div>
      <div class="acwr-display">
        <div class="acwr-gauge">
          <svg width="80" height="80" viewBox="0 0 80 80">
            <circle cx="40" cy="40" r="30" fill="none" stroke="var(--border)" stroke-width="6"/>
            <circle cx="40" cy="40" r="30" fill="none" stroke="${gaugeColor}" stroke-width="6"
              stroke-dasharray="${dash} ${circumference}" stroke-linecap="round"/>
          </svg>
          <div class="acwr-text" style="color:${gaugeColor}">${acwrVal}</div>
        </div>
        <div class="acwr-info">
          <div class="status"><span class="tag ${acwrTag}">${acwrLabel}</span></div>
          <div class="desc" style="margin-top:6px;">${acwrDesc}</div>
        </div>
      </div>
    </div>
  `;

  // â”€â”€ HR Zones â”€â”€
  const totalMin = d.zoneSeconds.reduce((s,v)=>s+v, 0) / 60;
  document.getElementById('hrZones').innerHTML = `
    <div class="zone-bar">
      ${d.zonePcts.map((p, i) => `
        <div class="zone-seg" style="width:${p*100}%;background:${ZONES[i].color};min-width:${p>0?'2px':'0'}"></div>
      `).join('')}
    </div>
    <div class="zone-legend">
      ${ZONES.map((z, i) => `
        <div class="zone-item">
          <div class="zone-dot" style="background:${z.color}"></div>
          ${z.label}: ${(d.zonePcts[i]*100).toFixed(0)}% (${Math.round(d.zoneSeconds[i]/60)}min)
        </div>
      `).join('')}
    </div>
    <div style="font-family:var(--mono);font-size:0.65rem;color:var(--muted);margin-top:8px;">
      ${d.act.average_heartrate ? `Avg HR: ${Math.round(d.act.average_heartrate)} bpm Â· ` : ''}
      ${d.act.max_heartrate ? `Max HR: ${Math.round(d.act.max_heartrate)} bpm Â· ` : ''}
      Dominant: ${ZONES[d.dominantZone].label}
      ${!d.hadRealZones ? ' Â· (estimated from avg HR â€” connect HR monitor for exact zones)' : ''}
    </div>
  `;

  // â”€â”€ Caption â”€â”€
  renderWeatherPace();
  renderCaption();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Weather
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWeather(lat, lng, unixTime) {
  try {
    // Open-Meteo: free, no API key, historical weather by hour
    const date = new Date(unixTime * 1000);
    const dateStr = date.toISOString().split('T')[0];
    const hour = date.getUTCHours();

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m,apparent_temperature,windspeed_10m,relativehumidity_2m,precipitation&start_date=${dateStr}&end_date=${dateStr}&timezone=auto`;
    const res = await fetch(url);
    if (!res.ok) return null;
    const data = await res.json();

    const h = data.hourly;
    const idx = Math.min(hour, (h.time?.length || 1) - 1);

    return {
      temp: h.temperature_2m?.[idx],
      feelsLike: h.apparent_temperature?.[idx],
      wind: h.windspeed_10m?.[idx],
      humidity: h.relativehumidity_2m?.[idx],
      precip: h.precipitation?.[idx],
      location: `${lat.toFixed(2)}, ${lng.toFixed(2)}`
    };
  } catch(e) {
    console.warn('Weather fetch failed:', e);
    return null;
  }
}

// Weather-adjusted pace penalty formula:
// Each 5Â°C above 15Â°C adds ~6 sec/km, humidity >70% adds ~3 sec/km
// Wind >20km/h adds ~4 sec/km. Heat index uses feels-like.
function calcWeatherPenalty(weather) {
  if (!weather) return 0;
  let penalty = 0;
  const temp = weather.feelsLike ?? weather.temp ?? 15;
  if (temp > 15) penalty += Math.round((temp - 15) / 5 * 6);
  if (temp < 5)  penalty -= Math.round((5 - temp) / 5 * 3); // cold bonus (minimal)
  if ((weather.humidity || 0) > 70) penalty += 3;
  if ((weather.wind || 0) > 20) penalty += 4;
  if ((weather.precip || 0) > 1) penalty += 2;
  return penalty;
}

function renderWeatherPace() {
  const d = state.analysisData;
  const w = d.weather;
  const act = d.act;
  const el = document.getElementById('weatherPace');

  const actualPaceSec = act.moving_time / (act.distance / 1000);
  const penalty = calcWeatherPenalty(w);
  const adjustedPaceSec = actualPaceSec - penalty;

  // Pace trend
  const paceThisStr = d.avgPaceThisWeek ? fmtPace(d.avgPaceThisWeek) : '--';
  const paceLastStr = d.avgPaceLastWeek ? fmtPace(d.avgPaceLastWeek) : '--';
  let paceTrendLabel = 'Insufficient data';
  let paceTrendColor = 'var(--muted)';
  if (d.avgPaceThisWeek && d.avgPaceLastWeek) {
    const diff = d.avgPaceLastWeek - d.avgPaceThisWeek; // positive = faster this week
    const absDiff = Math.abs(diff);
    if (diff > 5) { paceTrendLabel = `â†‘ ${Math.round(absDiff)}s/km faster this week`; paceTrendColor = 'var(--green)'; }
    else if (diff < -5) { paceTrendLabel = `â†“ ${Math.round(absDiff)}s/km slower this week`; paceTrendColor = '#ef4444'; }
    else { paceTrendLabel = 'Pace consistent week-on-week'; paceTrendColor = 'var(--yellow)'; }
  }

  const weatherHtml = w ? `
    <div class="metric-card blue" style="grid-column: span 2;">
      <div class="metric-label">Conditions at Run Start Â· GPS Auto-detected</div>
      <div style="display:flex; gap:20px; flex-wrap:wrap; margin-top:8px;">
        <div><div style="font-family:var(--mono);font-size:1.2rem;font-weight:500;">${w.temp?.toFixed(1) ?? '--'}Â°C</div><div style="font-family:var(--mono);font-size:0.6rem;color:var(--muted);">Temp</div></div>
        <div><div style="font-family:var(--mono);font-size:1.2rem;font-weight:500;">${w.feelsLike?.toFixed(1) ?? '--'}Â°C</div><div style="font-family:var(--mono);font-size:0.6rem;color:var(--muted);">Feels like</div></div>
        <div><div style="font-family:var(--mono);font-size:1.2rem;font-weight:500;">${w.humidity ?? '--'}%</div><div style="font-family:var(--mono);font-size:0.6rem;color:var(--muted);">Humidity</div></div>
        <div><div style="font-family:var(--mono);font-size:1.2rem;font-weight:500;">${w.wind?.toFixed(0) ?? '--'} km/h</div><div style="font-family:var(--mono);font-size:0.6rem;color:var(--muted);">Wind</div></div>
        ${w.precip > 0 ? `<div><div style="font-family:var(--mono);font-size:1.2rem;font-weight:500;">${w.precip?.toFixed(1)}mm</div><div style="font-family:var(--mono);font-size:0.6rem;color:var(--muted);">Rain</div></div>` : ''}
      </div>
      ${penalty !== 0 ? `<div style="font-family:var(--mono);font-size:0.68rem;color:var(--accent2);margin-top:10px;">
        Weather penalty: +${penalty}s/km Â· Adjusted pace: <strong>${fmtPace(adjustedPaceSec)}/km</strong> (vs actual ${fmtPace(actualPaceSec)}/km)
      </div>` : `<div style="font-family:var(--mono);font-size:0.68rem;color:var(--green);margin-top:10px;">Ideal conditions â€” no pace adjustment needed</div>`}
    </div>
  ` : `
    <div class="metric-card" style="grid-column: span 2;">
      <div class="metric-label">Weather</div>
      <div style="font-family:var(--mono);font-size:0.72rem;color:var(--muted);margin-top:6px;">
        ${act.start_latlng ? 'Fetching weather dataâ€¦' : 'No GPS coordinates in this activity â€” weather unavailable'}
      </div>
    </div>
  `;

  el.innerHTML = `
    <div class="metrics-grid" style="margin-bottom:0;">
      <div class="metric-card">
        <div class="metric-label">This Week Avg Pace</div>
        <div class="metric-value" style="font-size:1.3rem;">${paceThisStr}<span style="font-size:0.8rem;color:var(--muted)">/km</span></div>
        <div class="metric-sub" style="color:${paceTrendColor};">${paceTrendLabel}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Last Week Avg Pace</div>
        <div class="metric-value" style="font-size:1.3rem;">${paceLastStr}<span style="font-size:0.8rem;color:var(--muted)">/km</span></div>
        <div class="metric-sub">Prior 7-day average</div>
      </div>
      ${weatherHtml}
    </div>
  `;
}

function renderCaption() {
  const d = state.analysisData;
  const act = d.act;
  const existingCaption = act.description ? act.description.trim() : '';

  // Strip any previous KadellThePhysio Data block to avoid duplicates
  const stripped = existingCaption.replace(/\n*ğŸ“Š KADELLTHEPHYSIO DATA[\s\S]*$/, '').trim();

  const weekDiff = d.rollingAvg28 > 0 ? ((d.thisWeekKm - d.rollingAvg28) / d.rollingAvg28 * 100) : 0;
  const acwrStr = d.acwr !== null ? d.acwr.toFixed(2) : 'N/A';

  let acwrStatus = 'âœ… Optimal load range';
  if (d.acwr !== null) {
    if (d.acwr < 0.8) acwrStatus = 'ğŸ”µ Below baseline â€” safe to build';
    else if (d.acwr > 1.5) acwrStatus = 'ğŸ”´ Danger zone â€” rest needed';
    else if (d.acwr > 1.3) acwrStatus = 'âš¡ High load â€” monitor carefully';
    else acwrStatus = 'âœ… Optimal load range';
  }

  const dominantZonePct = (d.zonePcts[d.dominantZone] * 100).toFixed(0);
  const z2Pct = (d.zonePcts[1] * 100).toFixed(0);

  // Pace trend line
  let paceLine = '';
  if (d.avgPaceThisWeek && d.avgPaceLastWeek) {
    const diff = d.avgPaceLastWeek - d.avgPaceThisWeek;
    const absDiff = Math.round(Math.abs(diff));
    if (diff > 5) paceLine = `ğŸƒ Pace: ${fmtPace(d.avgPaceThisWeek)}/km avg this wk Â· â†‘ ${absDiff}s/km faster than last wk`;
    else if (diff < -5) paceLine = `ğŸƒ Pace: ${fmtPace(d.avgPaceThisWeek)}/km avg this wk Â· â†“ ${absDiff}s/km slower than last wk`;
    else paceLine = `ğŸƒ Pace: ${fmtPace(d.avgPaceThisWeek)}/km avg this wk Â· consistent with last wk`;
  } else if (d.avgPaceThisWeek) {
    paceLine = `ğŸƒ Pace: ${fmtPace(d.avgPaceThisWeek)}/km avg this week`;
  }

  // Weather line
  let weatherLine = '';
  const w = d.weather;
  if (w) {
    const penalty = calcWeatherPenalty(w);
    const actualPaceSec = act.moving_time / (act.distance / 1000);
    const adjustedPaceSec = actualPaceSec - penalty;
    const conditionStr = `${w.temp?.toFixed(0)}Â°C feels ${w.feelsLike?.toFixed(0)}Â°C Â· ${w.humidity}% humidity Â· ${w.wind?.toFixed(0)}km/h wind`;
    if (penalty > 0) {
      weatherLine = `ğŸŒ¡ï¸ ${conditionStr}\n   Weather-adjusted pace: ${fmtPace(adjustedPaceSec)}/km (+${penalty}s/km penalty)`;
    } else {
      weatherLine = `ğŸŒ¡ï¸ ${conditionStr} Â· Ideal conditions`;
    }
  }

  const lines = [
    `\n\nğŸ“Š KADELLTHEPHYSIO DATA`,
    `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,
    `ğŸ“… Weekly km: ${d.thisWeekKm.toFixed(1)} km (${weekDiff>0?'+':''}${weekDiff.toFixed(0)}% vs ${d.rollingAvg28.toFixed(1)} km avg)`,
    paceLine,
    weatherLine,
    `ğŸ’“ HR Zones: ${dominantZonePct}% ${ZONES[d.dominantZone].label} Â· Z2: ${z2Pct}%`,
    `âš¡ TSS: ${d.tss} pts Â· CTL: ${d.ctl28.toFixed(1)} TSS/day`,
    `ğŸ“ˆ ACWR: ${acwrStr} â€” ${acwrStatus}`,
    `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,
    `KadellThePhysio Data`
  ].filter(Boolean).join('\n');

  const preview = document.getElementById('captionPreview');
  if (stripped) {
    preview.innerHTML = `<span style="color:var(--muted)">${escHtml(stripped)}</span><span class="new-content">${escHtml(lines)}</span>`;
  } else {
    preview.innerHTML = `<span class="new-content">${escHtml(lines)}</span>`;
  }

  state.captionText = (stripped ? stripped + lines : lines);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Update Strava
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updateStrava() {
  const btn = document.getElementById('updateBtn');
  btn.disabled = true;
  showStatus('updateStatus', 'loading', 'Updating Strava activity descriptionâ€¦');

  try {
    const res = await fetch(`https://www.strava.com/api/v3/activities/${state.selectedActivity.id}`, {
      method: 'PUT',
      headers: {
        Authorization: `Bearer ${state.accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ description: state.captionText })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.message || `HTTP ${res.status}`);
    }

    showStatus('updateStatus', 'success', 'âœ“ Strava activity updated! Check your Strava app.');
  } catch (e) {
    showStatus('updateStatus', 'error', `Failed: ${e.message}`);
    btn.disabled = false;
  }
}

function copyCaption() {
  navigator.clipboard.writeText(state.captionText || '').then(() => {
    showStatus('updateStatus', 'success', 'âœ“ Caption text copied to clipboard');
    setTimeout(() => hideStatus('updateStatus'), 3000);
  });
}

function resetAnalysis() {
  document.getElementById('resultsPanel').classList.add('hidden');
  state.selectedActivity = null;
  state.analysisData = null;
  document.querySelectorAll('.activity-card').forEach(el => el.classList.remove('selected'));
  document.getElementById('analyseBtn').disabled = true;
  document.getElementById('step3Num').classList.remove('done');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDuration(sec) {
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  return `${m}:${String(s).padStart(2,'0')}`;
}

function fmtPace(secPerKm) {
  const m = Math.floor(secPerKm / 60);
  const s = Math.round(secPerKm % 60);
  return `${m}:${String(s).padStart(2,'0')}`;
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function showStatus(id, type, msg) {
  const el = document.getElementById(id);
  el.classList.remove('hidden', 'error', 'success', 'loading');
  el.classList.add('status-bar', type);
  el.innerHTML = type === 'loading' ? `<div class="spinner"></div>${msg}` : msg;
}

function hideStatus(id) {
  document.getElementById(id).classList.add('hidden');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  // Load saved credentials into fields
  const savedId = localStorage.getItem('strava_client_id');
  if (savedId) document.getElementById('clientId').value = savedId;

  // Check if returning from OAuth
  const params = new URLSearchParams(window.location.search);
  if (params.get('code')) {
    const ok = await handleCallback();
    if (ok) {
      document.getElementById('step2Num').classList.remove('locked');
      document.getElementById('fetchBtn').disabled = false;
    }
    return;
  }

  // Check if we have a valid cached token
  const cachedToken = localStorage.getItem('strava_access_token');
  const expiry = parseInt(localStorage.getItem('strava_token_expiry') || '0');
  const now = Math.floor(Date.now() / 1000);

  if (cachedToken && expiry > now - 300) {
    state.accessToken = cachedToken;
    state.clientId = localStorage.getItem('strava_client_id') || '';
    state.clientSecret = localStorage.getItem('strava_client_secret') || '';
    setConnected('Athlete');
  } else if (localStorage.getItem('strava_refresh_token')) {
    const ok = await refreshTokenIfNeeded();
    if (ok) setConnected('Athlete');
  }
}

init();
</script>
</body>
</html>
